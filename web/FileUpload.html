<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="layui/css/layui.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script>
    <script src="layui/layui.js"></script>
    <title>FileUpLoad</title>
</head>
<body>
<button type="button" class="layui-btn" id="uploadfile">
    <i class="layui-icon">&#xe67c;</i>上传
</button>
<div class="layui-progress layui-progress-big" lay-showPercent="yes" lay-filter="upload_progress_bar" lay-percent="0%">
    <div id="upload_progress" class="layui-progress-bar"></div>
</div>
</body>
<script>
    window.onload = function () {
        Number.prototype.MytoFixed = function (n) {
            if (n > 20 || n < 0) {
                throw new RangeError('toFixed() digits argument must be between 0 and 20');
            }
            const number = this;
            if (isNaN(number) || number >= Math.pow(10, 21)) {
                return number.toString();
            }
            if (typeof (n) == 'undefined' || n == 0) {
                return (Math.round(number)).toString();
            }

            let result = number.toString();
            const arr = result.split('.');

            // 整数的情况
            if (arr.length < 2) {
                result += '.';
                for (let i = 0; i < n; i += 1) {
                    result += '0';
                }
                return result;
            }

            const integer = arr[0];
            const decimal = arr[1];
            if (decimal.length == n) {
                return result;
            }
            if (decimal.length < n) {
                for (let i = 0; i < n - decimal.length; i += 1) {
                    result += '0';
                }
                return result;
            }
            result = integer + '.' + decimal.substr(0, n);
            const last = decimal.substr(n, 1);

            // 四舍五入，转换为整数再处理，避免浮点数精度的损失
            if (parseInt(last, 10) >= 5) {
                const x = Math.pow(10, n);
                result = (Math.round((parseFloat(result) * x)) + 1) / x;
                result = result.toFixed(n);
            }

            return result;
        };
    }
    layui.use(['upload', 'element'], function () {
        var t;
        var webSockets = [];
        layui.upload.render({
            elem: '#uploadfile'
            , url: 'uploadPhoto'
            , accept: 'file'
            // ,multiple:true
            , done: function (res, index, upload) {
                clearInterval(t);
                layui.element.progress('upload_progress_bar', '100%');
                $("#uploadfile").removeClass("layui-btn-disabled");
                for (var i = 0; i < webSockets.length; i++) {
                    console.log(webSockets[i])
                    webSockets[i].close();
                }
                webSockets = [];
            },
            before: function (arg) {
                arg.preview(function (index, file, result) {
                    // console.log(file)
                    layui.element.progress('upload_progress_bar', '0%');
                    $("#uploadfile").addClass("layui-btn-disabled");
                    t = setInterval(function () {
                        $.ajax({
                            url: "fileuploadstatis",
                            data: {filename: file.name},
                            complete: function (arg) {
                                if (arg.responseText && arg.responseText.indexOf("null") < 0) {
                                    let obj = JSON.parse(arg.responseText);
                                    layui.element.progress('upload_progress_bar', (obj.transfered / obj.fileSize).toFixed(2) * 100 + "%");
                                }
                            }
                        })
                    }, 100);
                    // if ("WebSocket" in window) {
                    //     var contextPath = document.location.pathname;
                    //     var index = contextPath.substr(1).indexOf("/");
                    //     contextPath = contextPath.substr(0, index + 1);
                    //     if (document.location.port) {
                    //         var url = "ws://" + window.location.host + ":" + document.location.port + contextPath + "/ws/fileUploadState";
                    //     } else {
                    //         var url = "ws://" + window.location.host + contextPath + "/ws/fileUploadState";
                    //     }
                    //     var ws = new WebSocket(url);
                    //     ws.onopen = function () {
                    //         ws.send(file.name);
                    //     }
                    //     ws.onmessage = function (arg) {
                    //         let obj = JSON.parse(arg.data);
                    //         // console.log(obj)
                    //         layui.element.progress('upload_progress_bar', (obj.transfered / obj.fileSize).toFixed(2) * 100 + "%");
                    //     };
                    //     ws.onclose = function () {
                    //         console.log("连接已关闭...");
                    //     };
                    //     window.onbeforeunload = function () {
                    //         ws.close();
                    //     }
                    //     webSockets.push(ws);
                    // }
                })
            }
        });
    });
</script>
</html>